name: Build and Push Docker Images

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: crpi-y34dw9cggtyfgmzy.cn-hangzhou.personal.cr.aliyuncs.com
  BACKEND_IMAGE_NAME: ${{ github.repository }}-backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Display build information
      run: |
        echo "ðŸš€ å¼€å§‹æž„å»ºDockeré•œåƒ"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "Registry: ${{ env.REGISTRY }}"
        echo "æž„å»ºæ—¶é—´: $(date)"

    - name: Check directory structure
      run: |
        echo "ðŸ“ æ£€æŸ¥é¡¹ç›®ç›®å½•ç»“æž„:"
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo ""
        echo "ðŸ“‚ æ ¹ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        echo "ðŸ“‚ backendç›®å½•å†…å®¹:"
        ls -la backend/ || echo "backendç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ðŸ“‚ frontendç›®å½•å†…å®¹:"
        ls -la frontend/ || echo "frontendç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ðŸ“‚ .github/workflowsç›®å½•å†…å®¹:"
        ls -la .github/workflows/ || echo ".github/workflowsç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "ðŸ” æ£€æŸ¥Dockerfileæ˜¯å¦å­˜åœ¨:"
        echo "backend/Dockerfile: $(ls -la backend/Dockerfile 2>/dev/null && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
        echo "frontend/Dockerfile: $(ls -la frontend/Dockerfile 2>/dev/null && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
        echo ""
        echo "ðŸ“Š ç›®å½•ç»“æž„æ£€æŸ¥å®Œæˆ"

    - name: Log in to Alibaba Cloud Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIBABA_CLOUD_USERNAME }}
        password: ${{ secrets.ALIBABA_CLOUD_PASSWORD }}

    - name: Verify registry login
      run: |
        echo "âœ… å·²ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡"
        echo "Registry: ${{ env.REGISTRY }}"
        echo "ç”¨æˆ·å: ${{ secrets.ALIBABA_CLOUD_USERNAME }}"
        echo "ç™»å½•æ—¶é—´: $(date)"

    - name: Extract metadata (tags, labels)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.REGISTRY }}/ai-travel-planner-backend
          ${{ env.REGISTRY }}/ai-travel-planner-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Debug build configuration
      run: |
        echo "ðŸ”§ è°ƒè¯•æž„å»ºé…ç½®:"
        echo "å½“å‰æäº¤: ${{ github.sha }}"
        echo "å·¥ä½œæµæ–‡ä»¶å†…å®¹:"
        cat .github/workflows/docker-build-push.yml | grep -A 10 -B 5 "Build and push backend image"
        echo ""
        echo "backendç›®å½•å†…å®¹:"
        ls -la backend/
        echo ""
        echo "Dockerfileè·¯å¾„: backend/Dockerfile"
        ls -la backend/Dockerfile

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ env.REGISTRY }}/ai-travel-planner-backend:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      env:
        BUILDKIT_PROGRESS: plain

    - name: Verify backend image
      if: github.event_name != 'pull_request'
      run: |
        echo "âœ… åŽç«¯é•œåƒæž„å»ºå®Œæˆ"
        echo "é•œåƒæ ‡ç­¾: ${{ env.REGISTRY }}/ai-travel-planner-backend:${{ github.sha }}"
        echo "æž„å»ºæ—¶é—´: $(date)"

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ env.REGISTRY }}/ai-travel-planner-frontend:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      env:
        BUILDKIT_PROGRESS: plain

    - name: Verify frontend image
      if: github.event_name != 'pull_request'
      run: |
        echo "âœ… å‰ç«¯é•œåƒæž„å»ºå®Œæˆ"
        echo "é•œåƒæ ‡ç­¾: ${{ env.REGISTRY }}/ai-travel-planner-frontend:${{ github.sha }}"
        echo "æž„å»ºæ—¶é—´: $(date)"

    - name: Generate deployment manifest
      if: github.event_name != 'pull_request'
      run: |
        cat > docker-compose.prod.yml << EOF
        version: '3.8'
        services:
          backend:
            image: ${{ env.REGISTRY }}/ai-travel-planner-backend:${{ github.sha }}
            environment:
              - NODE_ENV=production
            ports:
              - "3000:3000"
            restart: unless-stopped
            
          frontend:
            image: ${{ env.REGISTRY }}/ai-travel-planner-frontend:${{ github.sha }}
            ports:
              - "80:80"
            restart: unless-stopped
            depends_on:
              - backend
        EOF

    - name: Upload deployment manifest
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: deployment-manifest
        path: docker-compose.prod.yml
        retention-days: 30

    - name: Display deployment information
      if: github.event_name != 'pull_request'
      run: |
        echo "ðŸ“¦ éƒ¨ç½²æ¸…å•å·²ç”Ÿæˆ"
        echo "åŽç«¯é•œåƒ: ${{ env.REGISTRY }}/ai-travel-planner-backend:${{ github.sha }}"
        echo "å‰ç«¯é•œåƒ: ${{ env.REGISTRY }}/ai-travel-planner-frontend:${{ github.sha }}"
        echo "éƒ¨ç½²æ–‡ä»¶: docker-compose.prod.yml"
        echo "ç”Ÿæˆæ—¶é—´: $(date)"
        echo ""
        echo "âœ… æž„å»ºæµç¨‹å®Œæˆï¼"