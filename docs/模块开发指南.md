# AI旅行规划师 - 模块开发指南

## 1. 模块开发基本原则

### 1.1 单一职责原则
- 每个模块只负责一个明确的功能域
- 模块内部功能高度内聚
- 模块间依赖最小化

### 1.2 接口优先原则
- 先定义模块接口，再实现内部逻辑
- 接口设计要稳定且易于扩展
- 避免模块间直接依赖实现细节

### 1.3 测试驱动原则
- 每个模块必须有对应的单元测试
- 测试用例覆盖主要功能路径
- 测试代码质量与业务代码同等重要

## 2. 前端模块开发规范

### 2.1 组件开发规范

#### 2.1.1 组件文件结构
```typescript
// components/TripCard/TripCard.tsx
import React from 'react';
import { Trip } from '../../types/trip.types';
import './TripCard.css';

interface TripCardProps {
  trip: Trip;
  onEdit: (trip: Trip) => void;
  onDelete: (tripId: string) => void;
}

export const TripCard: React.FC<TripCardProps> = ({ trip, onEdit, onDelete }) => {
  return (
    <div className="trip-card">
      {/* 组件内容 */}
    </div>
  );
};

// components/TripCard/TripCard.css
.trip-card {
  /* 样式定义 */
}

// components/TripCard/index.ts
export { TripCard } from './TripCard';
```

#### 2.1.2 组件命名规范
- 组件文件名使用PascalCase
- 组件名称与文件名保持一致
- 文件夹名称与组件名称保持一致

### 2.2 Hook开发规范

#### 2.2.1 自定义Hook结构
```typescript
// hooks/useTripForm.ts
import { useState, useCallback } from 'react';
import { TripFormData } from '../types/trip.types';

export const useTripForm = (initialData?: TripFormData) => {
  const [formData, setFormData] = useState<TripFormData>(initialData || {});
  
  const updateField = useCallback((field: keyof TripFormData, value: any) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
  }, []);
  
  const resetForm = useCallback(() => {
    setFormData(initialData || {});
  }, [initialData]);
  
  return {
    formData,
    updateField,
    resetForm
  };
};
```

#### 2.2.2 Hook命名规范
- Hook名称以"use"开头
- 文件名与Hook名称保持一致
- 每个Hook只负责一个特定的逻辑

### 2.3 服务层开发规范

#### 2.3.1 API服务结构
```typescript
// services/tripService.ts
import { Trip, CreateTripRequest, UpdateTripRequest } from '../types/trip.types';
import { apiClient } from './apiClient';

export class TripService {
  private static readonly BASE_URL = '/api/trips';
  
  static async createTrip(request: CreateTripRequest): Promise<Trip> {
    const response = await apiClient.post(this.BASE_URL, request);
    return response.data;
  }
  
  static async getTrip(id: string): Promise<Trip> {
    const response = await apiClient.get(`${this.BASE_URL}/${id}`);
    return response.data;
  }
  
  static async updateTrip(id: string, request: UpdateTripRequest): Promise<Trip> {
    const response = await apiClient.put(`${this.BASE_URL}/${id}`, request);
    return response.data;
  }
  
  static async deleteTrip(id: string): Promise<void> {
    await apiClient.delete(`${this.BASE_URL}/${id}`);
  }
}
```

## 3. 后端模块开发规范

### 3.1 控制器开发规范

#### 3.1.1 控制器结构
```typescript
// controllers/trip.controller.ts
import { Request, Response } from 'express';
import { TripService } from '../services/trip.service';
import { CreateTripRequest, UpdateTripRequest } from '../types/trip.types';

export class TripController {
  static async createTrip(req: Request, res: Response) {
    try {
      const request: CreateTripRequest = req.body;
      const trip = await TripService.createTrip(request);
      res.status(201).json(trip);
    } catch (error) {
      res.status(500).json({ error: '创建行程失败' });
    }
  }
  
  static async getTrip(req: Request, res: Response) {
    try {
      const { id } = req.params;
      const trip = await TripService.getTrip(id);
      res.json(trip);
    } catch (error) {
      res.status(404).json({ error: '行程不存在' });
    }
  }
}
```

#### 3.1.2 错误处理规范
- 使用统一的错误处理中间件
- 返回标准的错误响应格式
- 记录详细的错误日志

### 3.2 服务层开发规范

#### 3.2.1 服务类结构
```typescript
// services/trip.service.ts
import { Trip } from '../models/trip.model';
import { CreateTripRequest, UpdateTripRequest } from '../types/trip.types';

export class TripService {
  static async createTrip(request: CreateTripRequest): Promise<Trip> {
    // 业务逻辑实现
    const trip = await Trip.create(request);
    return trip;
  }
  
  static async getTrip(id: string): Promise<Trip> {
    const trip = await Trip.findByPk(id);
    if (!trip) {
      throw new Error('行程不存在');
    }
    return trip;
  }
}
```

### 3.3 数据模型开发规范

#### 3.3.1 模型定义
```typescript
// models/trip.model.ts
import { DataTypes, Model, Optional } from 'sequelize';
import { sequelize } from '../core/database/connection';

interface TripAttributes {
  id: string;
  title: string;
  description?: string;
  startDate: Date;
  endDate: Date;
  budget: number;
  userId: string;
}

interface TripCreationAttributes extends Optional<TripAttributes, 'id'> {}

export class Trip extends Model<TripAttributes, TripCreationAttributes> 
  implements TripAttributes {
  
  public id!: string;
  public title!: string;
  public description?: string;
  public startDate!: Date;
  public endDate!: Date;
  public budget!: number;
  public userId!: string;
  
  public readonly createdAt!: Date;
  public readonly updatedAt!: Date;
}

Trip.init({
  id: {
    type: DataTypes.UUID,
    defaultValue: DataTypes.UUIDV4,
    primaryKey: true,
  },
  title: {
    type: DataTypes.STRING,
    allowNull: false,
  },
  description: {
    type: DataTypes.TEXT,
    allowNull: true,
  },
  startDate: {
    type: DataTypes.DATE,
    allowNull: false,
  },
  endDate: {
    type: DataTypes.DATE,
    allowNull: false,
  },
  budget: {
    type: DataTypes.DECIMAL(10, 2),
    allowNull: false,
  },
  userId: {
    type: DataTypes.UUID,
    allowNull: false,
  },
}, {
  sequelize,
  modelName: 'Trip',
  tableName: 'trips',
});
```

## 4. 测试开发规范

### 4.1 单元测试规范

#### 4.1.1 前端组件测试
```typescript
// components/TripCard/TripCard.test.tsx
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import { TripCard } from './TripCard';

describe('TripCard', () => {
  const mockTrip = {
    id: '1',
    title: '测试行程',
    startDate: new Date(),
    endDate: new Date(),
    budget: 1000,
  };
  
  it('应该正确显示行程信息', () => {
    render(<TripCard trip={mockTrip} onEdit={jest.fn()} onDelete={jest.fn()} />);
    
    expect(screen.getByText('测试行程')).toBeInTheDocument();
    expect(screen.getByText('¥1000')).toBeInTheDocument();
  });
  
  it('点击编辑按钮应该调用onEdit回调', () => {
    const mockOnEdit = jest.fn();
    render(<TripCard trip={mockTrip} onEdit={mockOnEdit} onDelete={jest.fn()} />);
    
    fireEvent.click(screen.getByText('编辑'));
    expect(mockOnEdit).toHaveBeenCalledWith(mockTrip);
  });
});
```

#### 4.1.2 后端服务测试
```typescript
// services/trip.service.test.ts
import { TripService } from './trip.service';
import { Trip } from '../models/trip.model';

jest.mock('../models/trip.model');

describe('TripService', () => {
  describe('createTrip', () => {
    it('应该成功创建行程', async () => {
      const mockRequest = {
        title: '测试行程',
        startDate: new Date(),
        endDate: new Date(),
        budget: 1000,
        userId: 'user-1',
      };
      
      const mockTrip = { id: '1', ...mockRequest };
      (Trip.create as jest.Mock).mockResolvedValue(mockTrip);
      
      const result = await TripService.createTrip(mockRequest);
      
      expect(Trip.create).toHaveBeenCalledWith(mockRequest);
      expect(result).toEqual(mockTrip);
    });
  });
});
```

### 4.2 集成测试规范

#### 4.2.1 API集成测试
```typescript
// tests/integration/trip.api.test.ts
import request from 'supertest';
import { app } from '../../src/app';

describe('Trip API', () => {
  describe('POST /api/trips', () => {
    it('应该创建新的行程', async () => {
      const tripData = {
        title: '集成测试行程',
        startDate: new Date().toISOString(),
        endDate: new Date().toISOString(),
        budget: 2000,
      };
      
      const response = await request(app)
        .post('/api/trips')
        .send(tripData)
        .set('Authorization', 'Bearer valid-token');
      
      expect(response.status).toBe(201);
      expect(response.body.title).toBe(tripData.title);
    });
  });
});
```

## 5. 文档编写规范

### 5.1 模块文档结构

#### 5.1.1 README.md模板
```markdown
# 模块名称

## 功能描述
简要描述模块的功能和用途

## 安装和使用
```bash
# 安装依赖
npm install

# 运行测试
npm test
```

## API文档

### 主要接口
- `functionName(params): returnType` - 功能描述

## 开发指南

### 本地开发
1. 克隆项目
2. 安装依赖
3. 运行开发服务器

## 测试
描述测试方法和覆盖率要求
```

### 5.2 代码注释规范

#### 5.2.1 JSDoc注释
```typescript
/**
 * 创建新的行程
 * @param request 创建行程的请求数据
 * @returns 创建的行程对象
 * @throws {Error} 当创建失败时抛出错误
 * @example
 * ```typescript
 * const trip = await createTrip({
 *   title: '测试行程',
 *   startDate: new Date(),
 *   endDate: new Date(),
 *   budget: 1000
 * });
 * ```
 */
async function createTrip(request: CreateTripRequest): Promise<Trip> {
  // 实现代码
}
```

## 6. 代码审查清单

### 6.1 前端代码审查清单
- [ ] 组件props类型定义完整
- [ ] 使用了正确的React Hooks
- [ ] 错误处理机制完善
- [ ] 样式代码规范
- [ ] 性能优化考虑

### 6.2 后端代码审查清单
- [ ] 输入验证完整
- [ ] 错误处理统一
- [ ] 数据库操作安全
- [ ] 日志记录完整
- [ ] 安全考虑充分

### 6.3 通用审查清单
- [ ] 代码符合ESLint规范
- [ ] 测试覆盖率达到要求
- [ ] 文档更新完整
- [ ] 性能指标达标
- [ ] 安全漏洞检查

## 7. 部署和发布

### 7.1 模块发布流程
1. **代码审查**：通过代码审查
2. **测试通过**：所有测试用例通过
3. **文档更新**：相关文档已更新
4. **版本标记**：标记版本号
5. **发布部署**：部署到相应环境

### 7.2 版本管理规范
- 使用语义化版本号（Semantic Versioning）
- 每次发布更新CHANGELOG.md
- 版本标签格式：v1.0.0

通过遵循这些开发规范，可以确保每个模块的质量和可维护性，同时保证模块间的协调工作。